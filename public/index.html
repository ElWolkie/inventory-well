<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sistema de Inventariado Inteligente - Well Testing</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #2c3e50, #3498db); color: #fff; padding: 30px; text-align: center; }
    .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
    .header p { opacity: .9; font-size: 1.1rem; }
    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; padding: 40px; }
    .input-section { background: #f8f9fa; padding: 30px; border-radius: 15px; border-left: 5px solid #3498db; }
    .results-section { background: #fff; padding: 30px; border-radius: 15px; border: 1px solid #e9ecef; max-height: 80vh; overflow-y: auto; }
    .section-title { color: #2c3e50; font-size: 1.5rem; margin-bottom: 25px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600; }
    .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: all .3s ease; }
    .form-group input:focus, .form-group select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,.1); }
    .btn-analyze { width: 100%; padding: 15px; background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all .3s ease; margin-top: 20px; }
    .btn-analyze:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(52, 152, 219, .3); }
    .btn-analyze:active { transform: translateY(0); }

    .equipment-category { background: #fff; border: 1px solid #e9ecef; border-radius: 12px; margin-bottom: 25px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
    .category-header { background: linear-gradient(135deg, #34495e, #2c3e50); color: #fff; padding: 15px 20px; font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
    .category-content { padding: 20px; }
    .equipment-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f8f9fa; gap: 16px; }
    .equipment-item:last-child { border-bottom: none; }
    .equipment-main { display: flex; align-items: center; gap: 10px; }
    .equipment-name { font-weight: 600; color: #2c3e50; }
    .equipment-specs { font-size: .85rem; color: #7f8c8d; margin-top: 3px; }
    .quantity-badge { background: #3498db; color: #fff; padding: 4px 12px; border-radius: 20px; font-size: .85rem; font-weight: 700; white-space: nowrap; }
    .recommended-badge { background: #e67e22; }

    .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid; }
    .alert-info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
    .alert-warning { background: #fff3e0; border-color: #ff9800; color: #e65100; }

    .summary-box { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
    .summary-item { display: inline-block; margin: 0 15px; }
    .summary-number { font-size: 2rem; font-weight: 800; display: block; }
    .summary-label { font-size: .9rem; opacity: .9; }

    .no-results { text-align: center; color: #7f8c8d; font-style: italic; padding: 40px; }
    .note-box { background: #fef9e7; border: 1px solid #f1c40f; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: .9rem; color: #856404; }
    .loading { display: none; text-align: center; padding: 20px; color: #3498db; }

    .icon { width: 24px; height: 24px; fill: currentColor; }

    /* Tooltip de imagen */
    .thumb { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; border: 1px solid #e0e0e0; background: #fafafa; }
    .thumb-wrap { position: relative; display: inline-flex; align-items: center; }
    .thumb-tooltip {
      --w: 1024px; --h: 860px;
      position: fixed; z-index: 50; left: 50%; transform: translateX(-50%) translateY(-8px);
      top: -8px; display: none; width: var(--w); height: var(--h);
      padding: 6px; border-radius: 10px; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .thumb-tooltip img { width: 100%; height: 100%; object-fit: contain; background: #fff; border-radius: 6px; }
    .thumb-tooltip::after { content: ""; position: fixed; bottom: -6px; left: 50%; transform: translateX(-50%);
      border-width: 6px; border-style: solid; border-color: #111 transparent transparent transparent; }
    .thumb-wrap:hover .thumb-tooltip { display: block; }

    /* Botones de exportaci√≥n */
    .export-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
    .export-btn { padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .export-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .export-btn.csv { background: #27ae60; color: white; }
    .export-btn.pdf { background: #e74c3c; color: white; }
    .export-btn.inventory { background: #3498db; color: white; }

    /* Modal para gesti√≥n de inventario */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .modal-header h2 { color: #2c3e50; }
    .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: #7f8c8d; }
    .modal-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #eee; }
    .modal-tab { padding: 10px 15px; background: #f8f9fa; border: none; border-radius: 5px 5px 0 0; cursor: pointer; }
    .modal-tab.active { background: #3498db; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .json-editor { width: 100%; height: 300px; font-family: monospace; padding: 15px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .modal-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .modal-btn.primary { background: #3498db; color: white; }
    .modal-btn.secondary { background: #e9ecef; color: #2c3e50; }

    @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; gap: 30px; } }



</style>

  <!-- Biblioteca para generar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
  <!-- ExcelJS (browser bundle) -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sistema de Inventariado Inteligente</h1>
      <p>Well Testing - Recomendaciones Autom√°ticas de Equipos</p>
    </div>

    <div class="main-content">
      <div class="input-section">
        <h2 class="section-title">
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          Par√°metros de la Prueba
        </h2>
        <form id="analysisForm">
          <div class="form-group">
            <label for="location">Nombre del Cliente</label>
            <input type="text" id="location" required placeholder="ej: Furrial, Chaima, Maracaibo, etc.">
          </div>
          <div class="form-group">
            <label for="clientAddress">Direcci√≥n</label>
            <input type="text" id="clientAddress" required placeholder="e.g. Campo Furrial">
          </div>
          <div class="form-group">
            <label for="environment">Tipo de Medici√≥n</label>
            <select id="environment" required>
              <option value="">Seleccionar...</option>
              <option value="onshore">Onshore</option>
              <option value="offshore">Offshore</option>
            </select>
          </div>
          <div class="form-group">
            <label for="pressure">Presi√≥n del Yacimiento (PSI)</label>
            <input type="number" id="pressure" min="0" max="5000" required placeholder="ej: 850">
          </div>
          <div class="form-group">
            <label for="oilType">Tipo de Crudo</label>
            <select id="oilType" required>
              <option value="">Seleccionar tipo...</option>
              <option value="ligero">Crudo Ligero (> 31.1¬∞ API)</option>
              <option value="medio">Crudo Medio (22.0¬∞ - 29.9¬∞ API)</option>
              <option value="pesado">Crudo Pesado (10.0¬∞ - 21.9¬∞ API)</option>
              <option value="extrapesado">Crudo Extrapesado (< 10.0¬∞ API)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="minBarrels">Barriles M√≠nimos Estimados (BTPD)</label>
            <input type="number" id="minBarrels" min="0" required placeholder="ej: 200">
          </div>
          <div class="form-group">
            <label for="maxBarrels">Barriles M√°ximos Estimados (BTPD)</label>
            <input type="number" id="maxBarrels" min="0" required placeholder="ej: 800">
          </div>
          <div class="form-group">
            <label for="testDuration">Tiempo Estimado de Medici√≥n (d√≠as)</label>
            <input type="number" id="testDuration" min="1" max="3600" required placeholder="ej: 5">
          </div>
          <button type="submit" class="btn-analyze" id="analyzeBtn">
            <svg class="icon" viewBox="0 0 24 24" style="display:inline-block;margin-right:8px;width:20px;height:20px;">
              <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
            </svg>
            <span id="btnText">Generar Recomendaciones</span>
          </button>
        </form>
      </div>

      <div class="results-section">
        <h2 class="section-title">
          <svg class="icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
          Recomendaciones de Equipos
        </h2>
        <div class="export-buttons" id="exportButtons" style="display: none;">
          <button class="export-btn csv" id="exportCSV">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <path d="M16 13H8"></path>
              <path d="M16 17H8"></path>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            Exportar CSV
          </button>
          <button class="export-btn pdf" id="exportPDF">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <path d="M16 13H8"></path>
              <path d="M16 17H8"></path>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            Exportar PDF
          </button>
          <button class="export-btn inventory" id="manageInventory">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
            Gestionar Inventario
          </button>
          <button class="export-btn excel" id="exportExcel">
          üìä Exportar XLSX
          </button>
          <button class="export-btn" id="saveBackup">üíæ Guardar Respaldo (local)</button>
          <button class="export-btn" id="exportSQL_pg">üóÑÔ∏è Exportar SQL (Postgres)</button>
          <button class="export-btn" id="exportSQL_mysql">üóÑÔ∏è Exportar SQL (MySQL)</button>
          <button class="export-btn secondary" onclick="vaciarCache()">üóë Vaciar Cache</button>
        </div>
        <div class="loading" id="loading"><p>üîÑ Generando recomendaciones...</p></div>
        <div id="results"><div class="no-results">Complete los par√°metros y presione "Generar Recomendaciones" para ver los equipos sugeridos.</div></div>
      </div>
    </div>
  </div>

  <!-- Modal para gesti√≥n de inventario -->
  <div class="modal" id="inventoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Gesti√≥n de Inventario</h2>
        <button class="close-modal" id="closeModal">&times;</button>
      </div>
      <div class="modal-tabs">
        <button class="modal-tab active" data-tab="json">Editor JSON</button>
        <button class="modal-tab" data-tab="help">Ayuda</button>
      </div>
      <div class="tab-content active" id="jsonTab">
        <p>Edita los datos del inventario en formato JSON. Los cambios se guardar√°n en el almacenamiento local del navegador.</p>
        <textarea class="json-editor" id="jsonEditor"></textarea>
      </div>
      <div class="tab-content" id="helpTab">
        <h3>Estructura del Inventario</h3>
        <p>El inventario debe seguir esta estructura JSON:</p>
        <pre>
{
  "separators": [
    {
      "id": "sep_01",
      "name": "Separador Bif√°sico N¬∞01",
      "type": "bif√°sico",
      "workingPressure": 548,
      "operatingPressure": 450,
      "capacity_light": 8.70,
      "capacity_medium": 4.35,
      "capacity_heavy": 1.24,
      "gasCapacity": 5.60
    }
  ],
  "mpfm": [...],
  "tools": {...},
  "specialEquipment": {...}
}
        </pre>
        <p><strong>Nota:</strong> Los cambios se aplicar√°n inmediatamente despu√©s de guardar.</p>
      </div>
      <div class="modal-actions">
        <button class="modal-btn secondary" id="resetInventory">Restablecer Valores Predeterminados</button>
        <button class="modal-btn primary" id="saveInventory">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <script>
/* ------------------ TU SCRIPT CORREGIDO (pegar sobre el original) ------------------ */
    // === Config ===
    const IMAGES_BASE = 'imagenes/'; // Directorio sugerido

    // Mapa de im√°genes por ID/Nombre. Ajusta los nombres de archivo seg√∫n tus assets.
    const imageMap = {
      // Separadores
      'sep_01': 'sep_01.png',
      'sep_02': 'sep_02.png',
      'sep_03': 'sep_03.png',
      'sep_04': 'sep_04.png',
      'sep_05': 'sep_05.png',
      'sep_06': 'sep_06.png',
      'sep_07': 'sep_07.png',
      // MPFM
      'mpfm_35_01': 'mpfm_35_01.png',
      'mpfm_35_02': 'mpfm_35_02.png',
      'mpfm_50': 'mpfm_50.png',
      'mpfm_87_01': 'mpfm_87_01.png',
      'mpfm_87_02': 'mpfm_87_02.png',
      // Herramientas (ejemplo por nombre exacto)
      'Dens√≠metro Anton Para DMA 35N': 'densimetro_dma35.png'
    };

    function getImageSrc(key) {
      const file = imageMap[key];
      return file ? (IMAGES_BASE + file) : null;
    }

    // === Base de datos (igual a tu versi√≥n, con trif√°sico marcado "offshore") ===
    const defaultEquipmentDatabase = {
      separators: [
        { id: 'sep_01', name: 'Separador Bif√°sico N¬∞01', type: 'bif√°sico', workingPressure: 548, operatingPressure: 450, capacity_light: 8.70, capacity_medium: 4.35, capacity_heavy: 1.24, gasCapacity: 5.60 },
        { id: 'sep_02', name: 'Separador Bif√°sico N¬∞02', type: 'bif√°sico', workingPressure: 548, operatingPressure: 450, capacity_light: 8.70, capacity_medium: 4.35, capacity_heavy: 1.24, gasCapacity: 5.60 },
        { id: 'sep_03', name: 'Separador Bif√°sico N¬∞03', type: 'bif√°sico', workingPressure: 713.8, operatingPressure: 690, capacity_light: 14.27, capacity_medium: 7.14, capacity_heavy: 2.04, gasCapacity: 5.60 },
        { id: 'sep_04', name: 'Separador Bif√°sico N¬∞04', type: 'bif√°sico', workingPressure: 548, operatingPressure: 520, capacity_light: 8.70, capacity_medium: 4.35, capacity_heavy: 1.24, gasCapacity: 5.60 },
        { id: 'sep_05', name: 'Separador Bif√°sico N¬∞05', type: 'bif√°sico', workingPressure: 713.8, operatingPressure: 690, capacity_light: 14.27, capacity_medium: 7.14, capacity_heavy: 2.04, gasCapacity: 5.60 },
        { id: 'sep_06', name: 'Separador Bif√°sico N¬∞06', type: 'bif√°sico', workingPressure: 713.8, operatingPressure: 690, capacity_light: 14.27, capacity_medium: 7.14, capacity_heavy: 2.04, gasCapacity: 5.60 },
        { id: 'sep_07', name: 'Separador Trif√°sico N¬∞07 (Offshore)', type: 'trif√°sico', workingPressure: 1000, operatingPressure: 900, capacity_light: 3.92, capacity_medium: 1.96, capacity_heavy: 0.78, gasCapacity: 5.60, special: 'offshore' }
      ],
      mpfm: [
        { id: 'mpfm_35_01', name: 'MPFM Roxar 2600 ID-35mm (MPFM-2848-18)', internalDiameter: 35, maxPressure: 1500, maxCapacity: 500, uncertainty_gas: 6, uncertainty_oil: 3, uncertainty_water: 2 },
        { id: 'mpfm_35_02', name: 'MPFM Roxar 2600 ID-35mm (MPFM-2835-18)', internalDiameter: 35, maxPressure: 1500, maxCapacity: 500, uncertainty_gas: 6, uncertainty_oil: 3, uncertainty_water: 2 },
        { id: 'mpfm_50', name: 'MPFM Roxar 2600 ID-50mm (MPFM-2514-17)', internalDiameter: 50, maxPressure: 5000, maxCapacity: 1000, uncertainty_gas: 6, uncertainty_oil: 3, uncertainty_water: 2 },
        { id: 'mpfm_87_01', name: 'MPFM Roxar 2600 ID-87mm (MPFM-2280-15)', internalDiameter: 87, maxPressure: 2204.57, maxCapacity: 1500, uncertainty_gas: 6, uncertainty_oil: 3, uncertainty_water: 2 },
        { id: 'mpfm_87_02', name: 'MPFM Roxar 2600 ID-87mm (MPFM-2172-13)', internalDiameter: 87, maxPressure: 2204.57, maxCapacity: 1500, uncertainty_gas: 6, uncertainty_oil: 3, uncertainty_water: 2 }
      ],
      tools: {
        ajustes_medicion: [
          'Alicate de presi√≥n', 'Alicate manual', 'Juegos de dados (1/4", 1/2")', 'Juegos de destornilladores', 'Llaves Allen y combinadas',
          'Llaves de golpe (1 1/16", 1 1/8", 1 1/4")', 'Llaves de tubo (12", 36")', 'Extensiones para rachet', 'Rachet 1/2" y 1/4"',
          'Mult√≠metro', 'Vernier'
        ],
        analisis_monitoreo: [
          'Detector de gases con 2 bater√≠as', 'Dens√≠metro Anton para DMA 35N', 'Radi√≥metro', 'Transmisor de presi√≥n', 'Probetas',
          'Cilindro graduado pl√°stico 1000mL', 'Porta provetas'
        ],
        instalacion_operacion: [
          'Barra de cobre con perno', 'Bater√≠as 1000 AMP', 'Bid√≥n 60 litros', 'Bolsa de trapos', 'Breakers 40AMP a 110V', 'Burros para tuber√≠as',
          'Cadena', 'Cinta de seguridad', 'Codos de uni√≥n de golpe 3"', 'Conos de seguridad', 'Esp√°rragos de 3/4"', 'Flange 3" ANSI 300 ciega',
          'Hammer Union Seal 2" y 3"', 'Mangueras (1", 2")', 'Mecate', 'Escalera', 'Pala'
        ],
        conexiones_acoplamiento: [
          'Crossover 1" brida a 1/2" brida', 'Crossover 1" brida a 1" NPT', 'Crossover 2" brida a 1" brida', 'Crossover brida 3" a uni√≥n 3"',
          'Crossover uni√≥n 2" a brida 3"', 'Crossover uni√≥n 3" a uni√≥n 2"'
        ],
        suministro_electrico: [
          'Convertidor RJ45 a USB', 'Controlador sistema fotovoltaico', 'Extensi√≥n para luminaria con toma corriente', 'Fuente alimentaci√≥n 110V-24V',
          'Inversor 24VDC a 110V', 'L√°mparas LED 107W', 'Paneles solares y base', 'Router con cargador'
        ],
        seguridad: [ 'Equipo autocontenido', 'Guantes de carnaza', 'Guantes de puntos', 'Extintor', 'Pilares para cinta de peligro' ],
        administrativo: [ 'Archivador dos gavetas', 'Escritorio dos gavetas', 'Impresora a color', 'Sillas', 'Porta-termos', 'Termo 48 LTS' ]
      },
      specialEquipment: {
        heavyCrude: [ 'Centrifugadora', 'Higr√≥metros de 9-21 API', 'Mandarria de bronce (2kg, 5kg)' ],
        extraHeavyCrude: [ 'Centrifugadora', 'Higr√≥metros de 9-21 API', 'Sistema de calentamiento', 'Mandarria de bronce (2kg, 5kg)' ],
        lightCrude: [ 'Dens√≠metro Anton para DMA 35N', 'Choke Manifold' ],
        longDuration: [ 'Bater√≠as extra para paneles solares', 'Equipos de repuesto b√°sicos', 'Materiales consumibles adicionales' ]
      }
    };

    // Cargar base de datos desde localStorage o usar la predeterminada
    function getEquipmentDatabase() {
      const storedData = localStorage.getItem('equipmentDatabase');
      return storedData ? JSON.parse(storedData) : defaultEquipmentDatabase;
    }

    // Guardar base de datos en localStorage
    function saveEquipmentDatabase(data) {
      localStorage.setItem('equipmentDatabase', JSON.stringify(data));
    }

    // === Motor de recomendaciones ===
    class RecommendationEngine {
      constructor() {
        this.database = getEquipmentDatabase();
      }

      refreshDatabase() {
        this.database = getEquipmentDatabase();
      }

      analyze(params) {
        const recommendations = {
          separators: this.recommendSeparators(params),
          mpfm: this.recommendMPFM(params),
          tools: this.recommendTools(params),
          alerts: this.generateAlerts(params)
        };
        return recommendations;
      }

      recommendSeparators(params) {
        const { pressure, oilType, maxBarrels, environment } = params;
        const suitable = [];
        const pressureCompatible = this.database.separators.filter(sep => sep.workingPressure >= pressure);
        const capacityKey = this.getCapacityKey(oilType);

        pressureCompatible.forEach(sep => {
          // Filtrar equipos marcados solo para OFFSHORE si no se seleccion√≥ OFFSHORE
          if (sep.special === 'offshore' && environment !== 'offshore') return;
          const capacity = sep[capacityKey] * 1000; // MBPD -> BOPD
          if (capacity >= maxBarrels * 0.8) {
            suitable.push({ ...sep, suitabilityScore: this.calculateSeparatorScore(sep, params), recommendedCapacity: capacity });
          }
        });
        return suitable.sort((a, b) => b.suitabilityScore - a.suitabilityScore);
      }

      recommendMPFM(params) {
        const { pressure, maxBarrels } = params;
        const suitable = [];
        this.database.mpfm.forEach(mpfm => {
          if (mpfm.maxPressure >= pressure && mpfm.maxCapacity >= maxBarrels) {
            suitable.push({ ...mpfm, suitabilityScore: this.calculateMPFMScore(mpfm, params) });
          }
        });
        return suitable.sort((a, b) => b.suitabilityScore - a.suitabilityScore);
      }

      recommendTools(params) {
        const { oilType, testDuration } = params;
        const tools = {
          ajustes_medicion: [...this.database.tools.ajustes_medicion],
          analisis_monitoreo: [...this.database.tools.analisis_monitoreo],
          instalacion_operacion: [...this.database.tools.instalacion_operacion],
          conexiones_acoplamiento: [...this.database.tools.conexiones_acoplamiento],
          suministro_electrico: [...this.database.tools.suministro_electrico],
          seguridad: [...this.database.tools.seguridad],
          administrativo: [...this.database.tools.administrativo],
          especiales: []
        };
        if (oilType === 'extrapesado') tools.especiales.push(...this.database.specialEquipment.extraHeavyCrude);
        else if (oilType === 'pesado') tools.especiales.push(...this.database.specialEquipment.heavyCrude);
        else if (oilType === 'ligero') tools.especiales.push(...this.database.specialEquipment.lightCrude);
        if (testDuration >= 7) tools.especiales.push(...this.database.specialEquipment.longDuration);
        return tools;
      }

      generateAlerts(params) {
        const alerts = [];
        const { pressure, maxBarrels, oilType, location, environment } = params;
        if (pressure > 2000) alerts.push({ type: 'warning', message: `Presi√≥n alta detectada (${pressure} PSI). Verificar equipos de seguridad y procedimientos especiales.` });
        if (maxBarrels > 1500) alerts.push({ type: 'info', message: `Producci√≥n alta estimada (${maxBarrels} BOPD). Consultar gr√°fica envolvente para MPFM seleccionado.` });
        const locationLower = location.toLowerCase();
        if ((locationLower.includes('chaima') || locationLower.includes('faja')) && (oilType === 'ligero' || oilType === 'medio')) {
          alerts.push({ type: 'warning', message: 'Inconsistencia: Chaima/Faja Petrol√≠fera t√≠picamente produce crudo pesado/extrapesado. Verificar datos.' });
        }
        if ((locationLower.includes('furrial') || locationLower.includes('maracaibo')) && (oilType === 'pesado' || oilType === 'extrapesado')) {
          alerts.push({ type: 'warning', message: 'Inconsistencia: Furrial/Maracaibo t√≠picamente produce crudo ligero. Verificar datos.' });
        }
        if (environment === 'offshore') {
          alerts.push({ type: 'info', message: 'Modo Offshore activo. Se priorizan equipos trif√°sicos y elementos aptos para ambiente marino.' });
        }
        if (oilType === 'extrapesado') alerts.push({ type: 'info', message: 'Crudo extrapesado (< 10¬∞ API). Se recomiendan equipos especiales para manejo y an√°lisis.' });
        return alerts;
      }

      getCapacityKey(oilType) {
        switch (oilType) {
          case 'ligero': return 'capacity_light';
          case 'medio': return 'capacity_medium';
          case 'pesado':
          case 'extrapesado': return 'capacity_heavy';
          default: return 'capacity_medium';
        }
      }

      calculateSeparatorScore(separator, params) {
        let score = 100;
        const pressureRatio = separator.workingPressure / params.pressure;
        if (pressureRatio > 2) score -= 20; else if (pressureRatio > 1.5) score -= 10;
        const capacityKey = this.getCapacityKey(params.oilType);
        score += separator[capacityKey] * 5;
        if (separator.operatingPressure >= params.pressure * 1.1) score += 10;
        return Math.round(score);
      }

      calculateMPFMScore(mpfm, params) {
        let score = 100;
        const capacityRatio = mpfm.maxCapacity / params.maxBarrels;
        if (capacityRatio >= 1.2 && capacityRatio <= 3) score += 30; else if (capacityRatio >= 1.0) score += 15;
        score += (10 - mpfm.uncertainty_oil) * 5;
        const pressureRatio = mpfm.maxPressure / params.pressure;
        if (pressureRatio >= 1.5) score += 20;
        return Math.round(score);
      }
    }

    const engine = new RecommendationEngine();

    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('results').style.display = 'none';
      const btn = document.getElementById('analyzeBtn');
      if (btn) { btn.disabled = true; const t = document.getElementById('btnText'); if (t) t.textContent = 'Procesando...'; }
    }
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('results').style.display = 'block';
      const btn = document.getElementById('analyzeBtn');
      if (btn) { btn.disabled = false; const t = document.getElementById('btnText'); if (t) t.textContent = 'Generar Recomendaciones'; }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('analysisForm');
      if (!form) return;
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        try {
          showLoading();
          const params = {
            location: document.getElementById('location')?.value.trim() || '',
            environment: document.getElementById('environment')?.value || '',
            pressure: parseInt(document.getElementById('pressure')?.value || 0),
            oilType: document.getElementById('oilType')?.value || '',
            minBarrels: parseInt(document.getElementById('minBarrels')?.value || 0),
            maxBarrels: parseInt(document.getElementById('maxBarrels')?.value || 0),
            testDuration: parseInt(document.getElementById('testDuration')?.value || 0)
          };
          if (params.maxBarrels < params.minBarrels) { alert('Los barriles m√°ximos deben ser mayores o iguales a los m√≠nimos'); hideLoading(); return; }
          if (isNaN(params.pressure) || params.pressure <= 0) { alert('Por favor ingrese una presi√≥n v√°lida'); hideLoading(); return; }

          setTimeout(() => {
            try {
              // 1) Generar recomendaciones y mostrar resultados (esto faltaba en tu versi√≥n)
              engine.refreshDatabase();
              const recommendations = engine.analyze(params);
              displayResults(recommendations, params);
              window.currentResults = recommendations;
              window.currentParams = params;

              // 2) Guardar en servidor (con fallback a localStorage)
              (async () => {
                try {
                  await saveEntryToServer(params, recommendations); // si falla, lanza excepci√≥n y cae al catch
                  // showToast lo maneja dentro de saveEntryToServer
                } catch (err) {
                  console.warn('Fallo al guardar en servidor, guardando localmente:', err);
                  try {
                    addEntryToLocalBackup(params, recommendations);
                    if (window.showToast) window.showToast('Servidor inaccesible ‚Äî respaldo guardado localmente.', 'warning', 'Fallback');
                    else console.info('Respaldo guardado localmente (fallback).');
                  } catch (e2) {
                    console.error('No se pudo guardar en local tampoco:', e2);
                    if (window.showToast) window.showToast('No se pudo guardar la entrada.', 'error', 'Error');
                  }
                }
              })();

              hideLoading();
            } catch (err) {
              console.error(err); alert('Error al generar recomendaciones. Verifique los datos.'); hideLoading();
            }
          }, 400);
        } catch (err) {
          console.error(err); alert('Error al procesar los datos.'); hideLoading();
        }
      });
    });

    function thumbHTML(key, alt) {
      const src = getImageSrc(key);
      if (!src) return '';
      // Imagen peque√±a + tooltip grande
      return `
        <span class="thumb-wrap" aria-label="Vista previa">
          <img class="thumb" src="${src}" alt="${alt}" onerror="this.style.visibility='hidden'" />
          <span class="thumb-tooltip" role="tooltip">
            <img src="${src}" alt="${alt}" onerror="this.parentElement.style.display='none'" />
          </span>
        </span>
      `;
    }

    function displayResults(recommendations, params) {
      const resultsDiv = document.getElementById('results');
      if (!resultsDiv) return;
      let html = '';

      const totalEquipment = (recommendations.separators || []).length + (recommendations.mpfm || []).length;
      const totalTools = Object.values(recommendations.tools || {}).reduce((sum, arr) => sum + arr.length, 0);

      // Mostrar botones de exportaci√≥n
      const exportButtonsEl = document.getElementById('exportButtons');
      if (exportButtonsEl) exportButtonsEl.style.display = 'flex';

      html += `
        <div class="summary-box">
          <div class="summary-item">
            <span class="summary-number">${totalEquipment}</span>
            <span class="summary-label">Equipos Principales</span>
          </div>
          <div class="summary-item">
            <span class="summary-number">${totalTools}</span>
            <span class="summary-label">Herramientas</span>
          </div>
          <div class="summary-item">
            <span class="summary-number">${(recommendations.alerts||[]).length}</span>
            <span class="summary-label">Alertas</span>
          </div>
        </div>`;

      (recommendations.alerts || []).forEach(alert => {
        html += `<div class="alert alert-${alert.type}">${alert.message}</div>`;
      });

      if ((recommendations.separators || []).length > 0) {
        html += `
          <div class="equipment-category">
            <div class="category-header">
              <span>Separadores Recomendados</span>
              <span>${recommendations.separators.length} opciones</span>
            </div>
            <div class="category-content">`;
        recommendations.separators.forEach((sep, index) => {
          const badgeClass = index === 0 ? 'recommended-badge' : '';
          const priority = index === 0 ? '‚≠ê RECOMENDADO' : `Opci√≥n ${index + 1}`;
          html += `
            <div class="equipment-item">
              <div class="equipment-main">
                ${thumbHTML(sep.id, sep.name)}
                <div>
                  <div class="equipment-name">${sep.name}${sep.special === 'offshore' ? ' ¬∑ <small>Offshore</small>' : ''}</div>
                  <div class="equipment-specs">
                    Presi√≥n Trabajo: ${sep.workingPressure} PSI |
                    Capacidad: ${sep.recommendedCapacity.toFixed(0)} BOPD |
                    Tipo: ${sep.type} | Score: ${sep.suitabilityScore}
                  </div>
                </div>
              </div>
              <div class="quantity-badge ${badgeClass}">${priority}</div>
            </div>`;
        });
        html += `</div></div>`;
      }

      if ((recommendations.mpfm || []).length > 0) {
        html += `
          <div class="equipment-category">
            <div class="category-header">
              <span>Medidores Multif√°sicos (MPFM)</span>
              <span>${recommendations.mpfm.length} opciones</span>
            </div>
            <div class="category-content">`;
        recommendations.mpfm.forEach((mpfm, index) => {
          const badgeClass = index === 0 ? 'recommended-badge' : '';
          const priority = index === 0 ? '‚≠ê RECOMENDADO' : `Opci√≥n ${index + 1}`;
          html += `
            <div class="equipment-item">
              <div class="equipment-main">
                ${thumbHTML(mpfm.id, mpfm.name)}
                <div>
                  <div class="equipment-name">${mpfm.name}</div>
                  <div class="equipment-specs">
                    ID: ${mpfm.internalDiameter}mm |
                    Presi√≥n Max: ${mpfm.maxPressure} PSI |
                    Capacidad Max: ${mpfm.maxCapacity} BOPD |
                    Incertidumbre Oil: ¬±${mpfm.uncertainty_oil}%
                  </div>
                </div>
              </div>
              <div class="quantity-badge ${badgeClass}">${priority}</div>
            </div>`;
        });
        html += `
            </div>
            <div class="note-box">üìù <strong>Nota importante:</strong> Consultar gr√°fica envolvente espec√≠fica para validar la capacidad final del MPFM seg√∫n condiciones exactas de operaci√≥n.</div>
          </div>`;
      }

      const categoryNames = {
        ajustes_medicion: 'Herramientas de Ajustes y Medici√≥n',
        analisis_monitoreo: 'Equipos de An√°lisis y Monitoreo',
        instalacion_operacion: 'Elementos de Instalaci√≥n y Operaci√≥n',
        conexiones_acoplamiento: 'Piezas de Conexi√≥n y Acoplamiento',
        suministro_electrico: 'Dispositivos de Suministro El√©ctrico',
        seguridad: 'Materiales de Seguridad',
        administrativo: 'Elementos Administrativos',
        especiales: 'Equipos Especiales'
      };

      Object.entries(recommendations.tools || {}).forEach(([category, toolList]) => {
        if (!toolList || !toolList.length) return;
        html += `
          <div class="equipment-category">
            <div class="category-header">
              <span>${categoryNames[category]}</span>
              <span>${toolList.length} elementos</span>
            </div>
            <div class="category-content">`;
        toolList.forEach(tool => {
          const maybeImg = getImageSrc(tool) ? thumbHTML(tool, tool) : '';
          html += `
            <div class="equipment-item">
              <div class="equipment-main">
                ${maybeImg}
                <div class="equipment-name">${tool}</div>
              </div>
              <div class="quantity-badge">1</div>
            </div>`;
        });
        html += `</div></div>`;
      });

      const oilTypeNames = {
        ligero: 'Crudo Ligero (> 31.1¬∞ API)',
        medio: 'Crudo Medio (22.0¬∞ - 29.9¬∞ API)',
        pesado: 'Crudo Pesado (10.0¬∞ - 21.9¬∞ API)',
        extrapesado: 'Crudo Extrapesado (< 10.0¬∞ API)'
      };

      html += `
        <div class="note-box">
          üìã <strong>Informaci√≥n adicional:</strong><br>
          ‚Ä¢ Ubicaci√≥n: ${params.location}<br>
          ‚Ä¢ Tipo de medici√≥n: ${params.environment?.toUpperCase() || '‚Äî'}<br>
          ‚Ä¢ Presi√≥n del yacimiento: ${params.pressure} PSI<br>
          ‚Ä¢ Tipo de crudo: ${oilTypeNames[params.oilType] || params.oilType}<br>
          ‚Ä¢ Rango de producci√≥n: ${params.minBarrels} - ${params.maxBarrels} BOPD<br>
          ‚Ä¢ Duraci√≥n estimada: ${params.testDuration} d√≠as<br><br>
          Lista base recomendada. Ajuste seg√∫n inventario local y condiciones espec√≠ficas del pozo.
        </div>`;

      resultsDiv.innerHTML = html;

      // Guardar los resultados actuales para exportaci√≥n
      window.currentResults = recommendations;
      window.currentParams = params;
    }

    // Auto-sugerencias de ubicaci√≥n ‚Üí tipo de crudo (como ten√≠as)
    document.addEventListener('DOMContentLoaded', function () {
      const locationInput = document.getElementById('location');
      const oilTypeSelect = document.getElementById('oilType');
      if (locationInput && oilTypeSelect) {
        locationInput.addEventListener('input', function () {
          const location = this.value.toLowerCase();
          if (!oilTypeSelect.value) {
            if (location.includes('chaima') || location.includes('faja')) oilTypeSelect.value = 'extrapesado';
            else if (location.includes('furrial') || location.includes('maracaibo')) oilTypeSelect.value = 'ligero';
          }
        });
      }
    });

    // Validaci√≥n en tiempo real de barriles
    document.addEventListener('DOMContentLoaded', function () {
      const minBarrelsInput = document.getElementById('minBarrels');
      const maxBarrelsInput = document.getElementById('maxBarrels');
      function validateBarrels() {
        const minBarrels = parseInt(minBarrelsInput.value) || 0;
        const maxBarrels = parseInt(maxBarrelsInput.value) || 0;
        if (maxBarrels > 0 && maxBarrels < minBarrels) maxBarrelsInput.setCustomValidity('Los barriles m√°ximos deben ser mayores o iguales a los m√≠nimos');
        else maxBarrelsInput.setCustomValidity('');
      }
      if (minBarrelsInput && maxBarrelsInput) {
        minBarrelsInput.addEventListener('input', validateBarrels);
        maxBarrelsInput.addEventListener('input', validateBarrels);
      }
    });

    function resetForm() {
      const form = document.getElementById('analysisForm');
      if (form) form.reset();
      const results = document.getElementById('results');
      if (results) results.innerHTML = '<div class="no-results">Complete los par√°metros y presione "Generar Recomendaciones" para ver los equipos sugeridos.</div>';
      const eb = document.getElementById('exportButtons');
      if (eb) eb.style.display = 'none';
    }

    // ===== FUNCIONALIDADES NUEVAS =====

    // Exportar a CSV
    document.getElementById('exportCSV')?.addEventListener('click', function() {
      if (!window.currentResults) {
        alert('No hay resultados para exportar. Genere recomendaciones primero.');
        return;
      }

      let csvContent = "Categoria,Equipo,Detalles,Cantidad\n";

      // Separadores
      (window.currentResults.separators || []).forEach(sep => {
        const details = `Presi√≥n: ${sep.workingPressure} PSI, Capacidad: ${sep.recommendedCapacity.toFixed(0)} BOPD, Tipo: ${sep.type}`;
        const priority = sep.suitabilityScore > 90 ? "RECOMENDADO" : "Alternativa";
        csvContent += `Separadores,${sep.name},"${details}",${priority}\n`;
      });

      // MPFM
      (window.currentResults.mpfm || []).forEach(mpfm => {
        const details = `ID: ${mpfm.internalDiameter}mm, Presi√≥n Max: ${mpfm.maxPressure} PSI, Incertidumbre: ¬±${mpfm.uncertainty_oil}%`;
        const priority = mpfm.suitabilityScore > 90 ? "RECOMENDADO" : "Alternativa";
        csvContent += `MPFM,${mpfm.name},"${details}",${priority}\n`;
      });

      // Herramientas
      Object.entries(window.currentResults.tools || {}).forEach(([category, tools]) => {
        (tools || []).forEach(tool => {
          csvContent += `${category},${tool},,1\n`;
        });
      });

      // Crear y descargar archivo
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const date = new Date().toISOString().slice(0, 10);

      link.setAttribute("href", url);
      link.setAttribute("download", `inventario_recomendado_${date}.csv`);
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // Exportar a PDF
    document.getElementById('exportPDF')?.addEventListener('click', function() {
      if (!window.currentResults) {
        alert('No hay resultados para exportar. Genere recomendaciones primero.');
        return;
      }

      try {
        // Usar jsPDF (aseg√∫rate de tener included jspdf en tu HTML)
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) throw new Error('jsPDF no encontrado. Incluye la librer√≠a jsPDF en tu HTML.');

        const doc = new jsPDF();
        const date = new Date().toISOString().slice(0, 10);
        let yPosition = 15;

        // T√≠tulo
        doc.setFontSize(18);
        doc.text("Sistema de Inventariado Inteligente", 105, yPosition, { align: "center" });
        yPosition += 10;
        doc.setFontSize(14);
        doc.text("Recomendaciones de Equipos - Well Testing", 105, yPosition, { align: "center" });
        yPosition += 15;

        // Par√°metros
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text("Par√°metros de la Prueba:", 14, yPosition);
        yPosition += 7;
        doc.setFont(undefined, 'normal');
        const oilTypeNames = {
          ligero: 'Crudo Ligero (> 31.1¬∞ API)',
          medio: 'Crudo Medio (22.0¬∞ - 29.9¬∞ API)',
          pesado: 'Crudo Pesado (10.0¬∞ - 21.9¬∞ API)',
          extrapesado: 'Crudo Extrapesado (< 10.0¬∞ API)'
        };

        doc.text(`Ubicaci√≥n: ${window.currentParams?.location || ''}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Tipo de Medici√≥n: ${(window.currentParams?.environment || '').toUpperCase()}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Presi√≥n del Yacimiento: ${window.currentParams?.pressure || ''} PSI`, 20, yPosition);
        yPosition += 6;
        doc.text(`Tipo de Crudo: ${oilTypeNames[window.currentParams?.oilType] || window.currentParams?.oilType || ''}`, 20, yPosition);
        yPosition += 6;
        doc.text(`Rango de Producci√≥n: ${window.currentParams?.minBarrels || 0} - ${window.currentParams?.maxBarrels || 0} BOPD`, 20, yPosition);
        yPosition += 6;
        doc.text(`Duraci√≥n Estimada: ${window.currentParams?.testDuration || 0} d√≠as`, 20, yPosition);
        yPosition += 10;

        // Separadores recomendados
        if ((window.currentResults?.separators || []).length > 0) {
          if (yPosition > 240) { doc.addPage(); yPosition = 15; }

          doc.setFont(undefined, 'bold');
          doc.text("Separadores Recomendados:", 14, yPosition);
          yPosition += 7;
          doc.setFont(undefined, 'normal');

          window.currentResults.separators.forEach((sep, idx) => {
            if (yPosition > 270) { doc.addPage(); yPosition = 15; }

            const priority = idx === 0 ? "‚≠ê RECOMENDADO" : `Opci√≥n ${idx + 1}`;
            doc.setFont(undefined, 'bold');
            doc.text(`${sep.name} (${priority})`, 20, yPosition);
            yPosition += 6;
            doc.setFont(undefined, 'normal');
            doc.text(`Presi√≥n Trabajo: ${sep.workingPressure} PSI, Capacidad: ${sep.recommendedCapacity.toFixed(0)} BOPD, Tipo: ${sep.type}, Score: ${sep.suitabilityScore}`, 20, yPosition);
            yPosition += 8;
          });
          yPosition += 5;
        }

        // MPFM recomendados
        if ((window.currentResults?.mpfm || []).length > 0) {
          if (yPosition > 240) { doc.addPage(); yPosition = 15; }

          doc.setFont(undefined, 'bold');
          doc.text("Medidores Multif√°sicos (MPFM):", 14, yPosition);
          yPosition += 7;
          doc.setFont(undefined, 'normal');

          window.currentResults.mpfm.forEach((mpfm, idx) => {
            if (yPosition > 270) { doc.addPage(); yPosition = 15; }

            const priority = idx === 0 ? "‚≠ê RECOMENDADO" : `Opci√≥n ${idx + 1}`;
            doc.setFont(undefined, 'bold');
            doc.text(`${mpfm.name} (${priority})`, 20, yPosition);
            yPosition += 6;
            doc.setFont(undefined, 'normal');
            doc.text(`ID: ${mpfm.internalDiameter}mm, Presi√≥n Max: ${mpfm.maxPressure} PSI, Capacidad Max: ${mpfm.maxCapacity} BOPD, Incertidumbre Oil: ¬±${mpfm.uncertainty_oil}%`, 20, yPosition);
            yPosition += 8;
          });
          yPosition += 5;
        }

        // Nota final
        if (yPosition > 250) { doc.addPage(); yPosition = 15; }
        doc.setFont(undefined, 'italic');
        doc.text("Nota: Lista base recomendada. Ajuste seg√∫n inventario local y condiciones espec√≠ficas del pozo.", 14, yPosition, { maxWidth: 180 });

        // Guardar PDF
        doc.save(`recomendaciones_inventario_${date}.pdf`);
      } catch (error) {
        console.error("Error al generar PDF:", error);
        alert("Error al generar el PDF. Aseg√∫rese de que las bibliotecas necesarias est√©n cargadas.");
      }
    });

    // Gesti√≥n de inventario - Modal
    const inventoryModal = document.getElementById('inventoryModal');
    const jsonEditor = document.getElementById('jsonEditor');

    // Abrir modal
    document.getElementById('manageInventory')?.addEventListener('click', function() {
      // Cargar datos actuales en el editor
      if (jsonEditor) jsonEditor.value = JSON.stringify(getEquipmentDatabase(), null, 2);
      if (inventoryModal) inventoryModal.style.display = 'flex';
    });

    // Cerrar modal
    document.getElementById('closeModal')?.addEventListener('click', function() {
      if (inventoryModal) inventoryModal.style.display = 'none';
    });

    // Cambiar pesta√±as
    document.querySelectorAll('.modal-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        // Desactivar todas las pesta√±as
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // Activar la pesta√±a clickeada
        this.classList.add('active');
        document.getElementById(this.dataset.tab + 'Tab')?.classList.add('active');
      });
    });

    // Guardar cambios en el inventario (versi√≥n correcta: actualiza inventario local y refresca engine)
    document.getElementById('saveInventory')?.addEventListener('click', function() {
      try {
        const newData = JSON.parse(jsonEditor.value); // puede lanzar
        saveEquipmentDatabase(newData);
        if (window.showToast) window.showToast('Inventario actualizado localmente.', 'success', 'Inventario');
        else alert('Inventario actualizado correctamente.');
        if (inventoryModal) inventoryModal.style.display = 'none';
        engine.refreshDatabase();
      } catch (error) {
        if (window.showToast) window.showToast('El JSON no es v√°lido. Corrija y reintente.', 'error', 'Error JSON');
        else alert('Error: El formato JSON no es v√°lido. Por favor, verifique la sintaxis.');
        console.error('Error guardando inventario:', error);
      }
    });

    // Restablecer valores predeterminados
    document.getElementById('resetInventory')?.addEventListener('click', function() {
      if (confirm('¬øEst√° seguro de que desea restablecer los valores predeterminados? Se perder√°n todos los cambios personalizados.')) {
        localStorage.removeItem('equipmentDatabase');
        if (jsonEditor) jsonEditor.value = JSON.stringify(defaultEquipmentDatabase, null, 2);
        if (window.showToast) window.showToast('Valores predeterminados restablecidos.', 'success');
        else alert('Valores predeterminados restablecidos.');
      }
    });

    // EXCEL EXPORT (dej√© tu implementaci√≥n)
    document.getElementById('exportExcel')?.addEventListener('click', async () => {
      try {
        if (!window.currentResults || !window.currentParams) return alert('Genere recomendaciones antes de exportar.');

        // 1) Crear workbook y worksheet
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'Sistema de Inventariado Inteligente';
        workbook.created = new Date();

        // Hoja: Resumen
        const wsResumen = workbook.addWorksheet('Resumen');
        wsResumen.columns = [{width:30},{width:60}];
        wsResumen.addRows([
          ['Cliente', document.getElementById('location')?.value || ''],
          ['Direcci√≥n', document.getElementById('clientAddress')?.value || ''],
          ['Tipo medici√≥n', (window.currentParams.environment || '').toUpperCase()],
          ['Presi√≥n (PSI)', window.currentParams.pressure],
          ['Rango (BOPD)', `${window.currentParams.minBarrels} - ${window.currentParams.maxBarrels}`],
          ['Duraci√≥n (d√≠as)', window.currentParams.testDuration],
          ['Generado el', new Date().toLocaleString()]
        ]);
        // Estilo cabecera resumen (primera columna)
        wsResumen.getColumn(1).eachCell(cell => cell.font = {bold:true});

        // Forzar alineaci√≥n de la columna de valores (columna B)
        wsResumen.getColumn(2).alignment = { horizontal: 'left', vertical: 'middle' };

        wsResumen.getCell('B4').numFmt = '0';   // Presi√≥n (sin decimales)
        wsResumen.getCell('B6').numFmt = '0';   // Duraci√≥n (d√≠as)

        // Centrar la fila de fecha por est√©tica (opcional)
        wsResumen.getCell('B7').alignment = { horizontal: 'center', vertical: 'middle' };

        // --- Insertar logo (imagen) ---
        const logoUrl = './logo.png'; // ajusta ruta
        try {
          const res = await fetch(logoUrl);
          if (res.ok) {
            const blob = await res.blob();
            const buf = await blob.arrayBuffer();
            const imageId = workbook.addImage({
              buffer: buf,
              extension: logoUrl.split('.').pop().toLowerCase()
            });
            wsResumen.addImage(imageId, {
              tl: { col: 2.6, row: 0.1 },
              ext: { width: 160, height: 60 }
            });
          } else {
            console.warn('Logo no encontrado:', res.status);
          }
        } catch(e) {
          console.warn('No se pudo cargar logo:', e);
        }

        // --- Hoja: Equipos (tabla con estilos, validaciones, protecci√≥n) ---
        const ws = workbook.addWorksheet('Equipos', {views:[{state:'normal'}]});
        ws.columns = [
          {header:'ID', key:'id', width:12},
          {header:'Categor√≠a', key:'cat', width:20},
          {header:'Nombre', key:'name', width:40},
          {header:'Detalles', key:'details', width:50},
          {header:'Prioridad', key:'priority', width:14},
          {header:'Cantidad Recomendada', key:'recommended', width:20},
          {header:'Stock Local', key:'stock', width:14},
          {header:'Solicitar?', key:'request', width:12},
          {header:'Notas', key:'notes', width:30}
        ];

        // Estilizar cabecera (fill + bold + centrado)
        ws.getRow(1).height = 22;
        ws.getRow(1).eachCell(cell => {
          cell.font = {bold:true, color:{argb:'FFFFFFFF'}};
          cell.alignment = {vertical:'middle', horizontal:'center'};
          cell.fill = {type:'pattern', pattern:'solid', fgColor:{argb:'FF2C3E50'}};
        });

        // Rellenar filas
        const maxBarrels = window.currentParams.maxBarrels || 1;
        function pushEquipo(row) { ws.addRow(row); }

        (window.currentResults.separators || []).forEach(sep => {
          const cap = (sep.recommendedCapacity && sep.recommendedCapacity > 0) ? sep.recommendedCapacity : 1;
          const rec = Math.max(1, Math.ceil(maxBarrels / cap));
          const priority = (sep.suitabilityScore && sep.suitabilityScore > 90) ? 'RECOMENDADO' : 'Alternativa';
          pushEquipo([sep.id||'', 'Separador', sep.name||'', `Presi√≥n:${sep.workingPressure} PSI; Cap:${cap.toFixed(0)} BOPD; Tipo:${sep.type||''}`, priority, rec, null, null, null]);
        });

        (window.currentResults.mpfm || []).forEach(m => {
          const cap = (m.maxCapacity && m.maxCapacity > 0) ? m.maxCapacity : 1;
          const rec = Math.max(1, Math.ceil(maxBarrels / cap));
          const priority = (m.suitabilityScore && m.suitabilityScore > 90) ? 'RECOMENDADO' : 'Alternativa';
          pushEquipo([m.id||'', 'MPFM', m.name||'', `ID:${m.internalDiameter}mm; PresionMax:${m.maxPressure} PSI; Cap:${cap}`, priority, rec, null, null, null]);
        });

        Object.entries(window.currentResults.tools || {}).forEach(([cat, lista]) => {
          (lista || []).forEach(item => pushEquipo(['', cat, item, '', 'Operativa', 1, null, null, null]));
        });

        const firstDataRow = 2;
        const lastDataRow = ws.rowCount;
        for (let r = firstDataRow; r <= lastDataRow; r++) {
          const cellRec = ws.getCell(`F${r}`);
          cellRec.numFmt = '0';
          ws.getCell(`H${r}`).value = { formula: `IF(G${r}>=F${r},"No","S√≠")` };
          ws.getCell(`H${r}`).alignment = { horizontal:'center' };
        }

        ws.autoFilter = { from: 'A1', to: `I${lastDataRow}` };

        const priorities = ['RECOMENDADO','Alternativa','Operativa'];
        for (let r = 2; r <= lastDataRow; r++) {
          ws.getCell(`E${r}`).dataValidation = {
            type: 'list',
            allowBlank: true,
            formulae: [`"${priorities.join(',')}"`],
            showErrorMessage: true,
            errorTitle: 'Valor inv√°lido',
            error: 'Seleccione una opci√≥n de la lista'
          };
        }

        ws.eachRow(row => {
          row.eachCell(cell => {
            cell.protection = { locked: false };
          });
        });

        ['A','B','C','D','E','F'].forEach(col => {
          ws.getColumn(col).eachCell((cell, rowNumber) => {
            cell.protection = { locked: true };
          });
        });

        await ws.protect('12345', {
          selectLockedCells: true,
          selectUnlockedCells: true,
          formatColumns: false,
          formatRows: false,
          insertRows: false,
          deleteRows: false
        });

        ws.getColumn('F').alignment = { horizontal:'center' };
        ws.getColumn('G').alignment = { horizontal:'center' };
        ws.getColumn('H').alignment = { horizontal:'center' };

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const clientName = (document.getElementById('location')?.value || 'cliente').replace(/[^a-z0-9_\-]/gi, '_');
        const filename = `inventario_${clientName}_${new Date().toISOString().slice(0,10)}.xlsx`;
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

      } catch (err) {
        console.error('Error exportando con ExcelJS:', err);
        alert('Error generando el Excel (ver consola).');
      }
    });

    // ----------------------- Helpers para backup y SQL -----------------------

    function getBackups() {
      try {
        return JSON.parse(localStorage.getItem('entries_backup') || '[]');
      } catch (e) {
        console.warn('Error parse entries_backup:', e);
        return [];
      }
    }
    function saveBackups(arr) { localStorage.setItem('entries_backup', JSON.stringify(arr)); }

    // Escapa cadenas para SQL (duplica comillas simples y barras)
    function escapeSQLString(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/\\/g, '\\\\').replace(/'/g, "''");
    }

    // Guarda una entrada en el respaldo local
    function addEntryToLocalBackup(params, results) {
      const backups = getBackups();
      const entry = {
        client_name: (params.location || '') + '',
        client_address: (document.getElementById('clientAddress')?.value || '') + '',
        environment: params.environment || '',
        pressure: params.pressure || null,
        oil_type: params.oilType || '',
        min_barrels: params.minBarrels || null,
        max_barrels: params.maxBarrels || null,
        test_duration: params.testDuration || null,
        results: results,
        params: params,
        created_at: new Date().toISOString()
      };
      backups.push(entry);
      saveBackups(backups);
      return entry;
    }

    // Export SQL via API (usa endpoint que tienes en index.js)
    document.getElementById('exportSQL_pg')?.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/entries/export?type=postgres');
        if (!res.ok) {
          const txt = await res.text().catch(()=>res.statusText);
          return window.showToast ? window.showToast('Error generando backup: ' + txt, 'error') : alert('Error generando backup: ' + txt);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `inventario_backup_postgres_${new Date().toISOString().slice(0,10)}.sql`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        if (window.showToast) window.showToast('Backup SQL descargado.', 'success');
      } catch (err) {
        console.error(err);
        if (window.showToast) window.showToast('Error exportando backup.', 'error');
        else alert('Error exportando backup.');
      }
    });

    // Generador de dump SQL para MySQL (local)
    function generateMySQLDump() {
      const backups = getBackups();
      if (!backups.length) return null;

      const header = `-- Export generado por Sistema de Inventariado Inteligente\n-- Fecha: ${new Date().toISOString()}\n\n`;
      const createTable = `
-- Tabla: entries (MySQL)
CREATE TABLE IF NOT EXISTS entries (
  id INT AUTO_INCREMENT PRIMARY KEY,
  client_name TEXT NOT NULL,
  client_address TEXT,
  environment VARCHAR(64),
  pressure INT,
  oil_type VARCHAR(64),
  min_barrels INT,
  max_barrels INT,
  test_duration INT,
  results JSON,
  params JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
\n`;

      let inserts = '';
      backups.forEach(b => {
        const client = escapeSQLString(b.client_name || '');
        const addr   = escapeSQLString(b.client_address || '');
        const env    = escapeSQLString(b.environment || '');
        const pressure = (b.pressure === null || b.pressure === undefined) ? 'NULL' : b.pressure;
        const oil = escapeSQLString(b.oil_type || '');
        const minb = (b.min_barrels === null || b.min_barrels === undefined) ? 'NULL' : b.min_barrels;
        const maxb = (b.max_barrels === null || b.max_barrels === undefined) ? 'NULL' : b.max_barrels;
        const td   = (b.test_duration === null || b.test_duration === undefined) ? 'NULL' : b.test_duration;
        const resultsJSON = escapeSQLString(JSON.stringify(b.results || {}));
        const paramsJSON  = escapeSQLString(JSON.stringify(b.params || {}));
        const created    = escapeSQLString(b.created_at || new Date().toISOString());

        inserts += `INSERT INTO entries (client_name, client_address, environment, pressure, oil_type, min_barrels, max_barrels, test_duration, results, params, created_at)\n`;
        inserts += `VALUES ('${client}', '${addr}', '${env}', ${pressure}, '${oil}', ${minb}, ${maxb}, ${td}, '${resultsJSON}', '${paramsJSON}', '${created}');\n\n`;
      });

      return header + createTable + inserts;
    }

    // Descargar texto como archivo
    function downloadTextFile(filename, text) {
      const blob = new Blob([text], { type: 'text/sql;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Listeners para botones
    document.getElementById('saveBackup')?.addEventListener('click', () => {
      if (!window.currentResults || !window.currentParams) return alert('Genere recomendaciones primero.');
      addEntryToLocalBackup(window.currentParams, window.currentResults);
      alert('Entrada guardada en respaldo local (localStorage).');
    });

    // Export SQL MySQL (local generator + download)
    document.getElementById('exportSQL_mysql')?.addEventListener('click', () => {
      const sql = generateMySQLDump();
      if (!sql) return alert('No hay respaldos para exportar. Genere y guarde al menos una entrada.');
      const fname = `inventario_backup_mysql_${new Date().toISOString().slice(0,10)}.sql`;
      downloadTextFile(fname, sql);
    });

    // Strings informativas sueltas (no hacen nada pero las dej√© como estaban)
    `-- Export generado por Sistema de Inventariado Inteligente\n`
    `-- Fecha: 2025-09-03T18:37:12.345Z\n`

    `-- Tabla: entries
      CREATE TABLE IF NOT EXISTS entries (
      id SERIAL PRIMARY KEY,
      client_name TEXT NOT NULL,
      client_address TEXT,
      environment TEXT,
      pressure INTEGER,
      oil_type TEXT,
      min_barrels INTEGER,
      max_barrels INTEGER,
      test_duration INTEGER,
      results JSONB NOT NULL,
      params JSONB NOT NULL,
      created_at TIMESTAMPTZ DEFAULT now()
    );
    \n`;

    `INSERT INTO entries (client_name, client_address, environment, pressure, oil_type, min_barrels, max_barrels, test_duration, results, params, created_at)\n`
    `VALUES ('Furrial', 'Campo Furrial', 'onshore', 850, 'ligero', 200, 800, 5, '{"separators":[...],"mpfm":[...]} '::jsonb, '{"location":"Furrial","pressure":850,...}'::jsonb, '2025-09-03T18:36:00.000Z');n`

    /* -------------------- Toasts globales + Helpers de backup -------------------- */
    (function () {
      // Container de toasts
      let toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.style.position = 'fixed';
        toastContainer.style.top = '18px';
        toastContainer.style.right = '18px';
        toastContainer.style.zIndex = 9999;
        toastContainer.style.display = 'flex';
        toastContainer.style.flexDirection = 'column';
        toastContainer.style.gap = '10px';
        document.body.appendChild(toastContainer);
      }

      // showToast ahora global
      window.showToast = function (message, type = 'info', title = '') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.style.minWidth = '220px';
        toast.style.maxWidth = '420px';
        toast.style.background = '#fff';
        toast.style.padding = '12px 14px';
        toast.style.borderRadius = '10px';
        toast.style.boxShadow = '0 8px 26px rgba(0,0,0,0.18)';
        toast.style.display = 'flex';
        toast.style.gap = '12px';
        toast.style.alignItems = 'center';
        toast.style.borderLeft = '6px solid transparent';
        if (type === 'success') toast.style.borderLeftColor = '#2ecc71';
        else if (type === 'error') toast.style.borderLeftColor = '#e74c3c';
        else if (type === 'warning') toast.style.borderLeftColor = '#f39c12';
        else toast.style.borderLeftColor = '#3498db';

        const emoji = type === 'success' ? '‚úÖ' : type === 'error' ? '‚õî' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

        toast.innerHTML = `<div style="font-size:18px">${emoji}</div>
          <div style="display:flex;flex-direction:column;">
            ${title ? `<div style="font-weight:700">${title}</div>` : ''}
            <div style="opacity:.95">${message}</div>
          </div>
          <button aria-label="Cerrar" style="margin-left:auto;background:none;border:none;font-size:16px;cursor:pointer;color:#666">&times;</button>`;

        // close handler
        toast.querySelector('button').addEventListener('click', () => toast.remove());
        toastContainer.appendChild(toast);

        // auto remove
        setTimeout(() => { try { toast.remove(); } catch (e) {} }, 4500);
        return toast;
      };

      // Backup helpers (global)
      window.getBackups = function () {
        try {
          return JSON.parse(localStorage.getItem('entries_backup') || '[]');
        } catch (e) {
          console.warn('Error parse entries_backup:', e);
          return [];
        }
      };
      window.saveBackups = function (arr) { localStorage.setItem('entries_backup', JSON.stringify(arr)); };

      // update contador visual
      window.updateBackupCount = function () {
        const el = document.getElementById('backupCount');
        if (!el) return;
        const c = window.getBackups().length;
        el.textContent = `Respaldo: ${c}`;
      };

      // escape SQL (si sigues usando export SQL)
      window.escapeSQLString = function (str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/\\/g, '\\\\').replace(/'/g, "''");
      };

      // funci√≥n central para agregar entry
      window.addEntryToLocalBackup = function (params, results) {
        const backups = window.getBackups();
        const entry = {
          client_name: (params.location || '') + '',
          client_address: (document.getElementById('clientAddress')?.value || '') + '',
          environment: params.environment || '',
          pressure: params.pressure || null,
          oil_type: params.oilType || '',
          min_barrels: params.minBarrels || null,
          max_barrels: params.maxBarrels || null,
          test_duration: params.testDuration || null,
          results: results,
          params: params,
          created_at: new Date().toISOString()
        };
        backups.push(entry);
        window.saveBackups(backups);
        window.updateBackupCount();
        return entry;
      };

      // inicializar contador al cargar
      document.addEventListener('DOMContentLoaded', () => {
        window.updateBackupCount();
      });

    })(); // end IIFE

    /* -------------------- Reemplazar alert() por toasts (opcional) -------------------- */
    window.alert = function (msg) {
      if (window.showToast) window.showToast(String(msg), 'warning', 'Aviso');
      else console.log(msg);
    };

    /* -------------------- Botones / listeners finales -------------------- */
    document.getElementById('saveBackup')?.addEventListener('click', () => {
      if (!window.currentResults || !window.currentParams) {
        return window.showToast ? window.showToast('Genere recomendaciones primero.', 'warning', 'Sin datos') : console.warn('Genere recomendaciones primero.');
      }
      window.addEntryToLocalBackup(window.currentParams, window.currentResults);
      window.showToast('Entrada guardada en respaldo local.', 'success', 'Respaldo creado');
    });

    function vaciarCache() {
      localStorage.clear();
      sessionStorage.clear();
      alert('Cach√© Vaciada.');
    }

    // frontend: funci√≥n que guarda en el servidor
    async function saveEntryToServer(params, results) {
      try {
        const payload = {
          client_name: (params.location||''),
          client_address: (document.getElementById('clientAddress')?.value||''),
          environment: params.environment || '',
          pressure: params.pressure || null,
          oil_type: params.oilType || '',
          min_barrels: params.minBarrels || null,
          max_barrels: params.maxBarrels || null,
          test_duration: params.testDuration || null,
          results: results,
          params: params,
          created_at: new Date().toISOString()
        };

        // usa ruta relativa (mejor pr√°ctica) para que funcione si sirves frontend y API en mismo host
        const resp = await fetch('/api/entries', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          const text = await resp.text().catch(()=>null);
          throw new Error('Server error: ' + (text || resp.status));
        }
        const data = await resp.json();
        if (window.showToast) window.showToast('Entrada guardada en la base de datos.', 'success', 'Guardado');
        return data;
      } catch (err) {
        console.warn('saveEntryToServer error:', err);
        // fallback opcional: guardar en localStorage si falla
        if (window.addEntryToLocalBackup) {
          window.addEntryToLocalBackup(params, results);
          if (window.showToast) window.showToast('Servidor inaccesible ‚Äî respaldo guardado localmente.', 'warning', 'Fallback');
        } else {
          if (window.showToast) window.showToast('No se pudo guardar entrada local ni en servidor.', 'error');
        }
        throw err;
      }
    }
</script>
</body>
</html>